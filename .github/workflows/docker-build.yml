name: Build and Push GPU Docker Image

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      # ============================================
      # AGGRESSIVE DISK CLEANUP - Frees ~30-50GB
      # ============================================
      - name: Free Disk Space (Ubuntu)
        run: |
          echo "=== Before cleanup ==="
          df -h
          
          echo "=== Removing large packages ==="
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          
          echo "=== Removing Docker images ==="
          sudo docker image prune --all --force || true
          
          echo "=== Removing apt cache ==="
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          
          echo "=== Removing misc large directories ==="
          sudo rm -rf /usr/local/graalvm/
          sudo rm -rf /usr/local/.ghcup/
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/local/lib/node_modules
          
          echo "=== After cleanup ==="
          df -h
      
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Create GPU Dockerfile
        run: |
          cat > dockerfile.gpu << 'EOF'
          FROM paddlepaddle/paddle:2.6.2-gpu-cuda11.7-cudnn8.4-trt8.4
          
          WORKDIR /app
          
          # Install dependencies in a single layer and clean up
          RUN apt-get update && apt-get install -y --no-install-recommends \
              libgl1 \
              libglib2.0-0 \
              libgomp1 \
              libsm6 \
              libxext6 \
              libxrender-dev \
              libgl1-mesa-glx \
              libxml2-dev \
              libxslt1-dev \
              zlib1g-dev \
              && apt-get clean \
              && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
          
          # Copy and install Python requirements
          COPY requirements.gpu.txt .
          RUN pip install --upgrade pip && \
              pip install --default-timeout=300 --no-cache-dir -r requirements.gpu.txt && \
              rm -rf ~/.cache/pip
          
          # Copy application code
          COPY docker_ocr.py .
          
          EXPOSE 5000
          
          ENV CUDA_VISIBLE_DEVICES=0
          ENV PYTHONUNBUFFERED=1
          
          CMD ["python", "docker_ocr.py"]
          EOF
      
      - name: Create GPU Requirements
        run: |
          cat > requirements.gpu.txt << 'EOF'
          flask==2.3.3
          paddleocr==2.7.0
          opencv-python-headless==4.8.1.78
          numpy==1.24.3
          werkzeug==2.3.7
          EOF
      
      - name: Check disk space before build
        run: df -h
      
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./dockerfile.gpu
          push: true
          tags: |
            growlerf18/paddle-ocr-gpu:latest
            growlerf18/paddle-ocr-gpu:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max